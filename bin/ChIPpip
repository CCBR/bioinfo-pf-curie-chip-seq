#!/bin/bash

## ChIP Research Pipeline
## Copyleft 2018 Institut Curie
## Author(s):  Nicolas Servant, AurÃ©lie Teissandier
## Contact: nicolas.servant@curie.fr
## This software is distributed without any guarantee under the terms of the GNU General
## Public License, either Version 2, June 1991 or Version 3, June 2007.

SOFT="ChIPpip"
VERSION="0.0.2"
MODE="TF"

function usage {
    echo -e "usage : $SOFT -f FORWARD -o OUTPUT -c CONFIG [-r REVERSE][-b BAM][-F CONTROL_FORWARD][-R CONTROL_REVERSE][-B CONTROL_BAM][-s SAMPLE_ID] [-l] [-d] [-h] [-v]"
    echo -e "Use option -h|--help for more information"
}

function help {
    usage;
    echo
    echo "$SOFT $VERSION"
    echo "---------------"
    echo "OPTIONS"
    echo
    echo "   -f|--forward TREATMENT_FORWARD: forward fastq file for ChIP"
    echo "   -c|--conf CONFIG: configuration file for ChIP processing"
    echo "   -o|--output OUTPUT: output folder"
    echo "   [-r|--reverse TREATMENT_REVERSE]: reverse fastq file for ChIP"
    echo "   [-b|--bam TREATMENT_BAM]: aligned BAM file for ChIP"
    echo "   [-F|--controlforward CONTROL_FORWARD]: forward fastq file for Control"
    echo "   [-R|--controlreverse CONTROL_REVERSE]: reverse fastq file for Control"
    echo "   [-B|--controlbam CONTROL_BAM]: BAM file for Control"
    echo "   [-l|--broad]: Broad mode for large histone mark"
    echo "   [-s|--sample ID]: sample ID"
    echo "   [-d|--dryrun]: dry run mode"
    echo "   [-h|--help]: help"
    echo "   [-v|--version]: version"
    exit;
}

function version {
    echo -e "$SOFT version $VERSION"
    exit
}

function set_dry_run {
    DRY_RUN=1
}

function set_broad_mode {
    MODE="BROAD"
}

function opts_error {
    echo -e "Error : invalid parameters !" >&2
    echo -e "Use $SOFT -h for help"
    exit
}

if [ $# -lt 1 ]
then
    usage
    exit
fi

# Transform long options to short ones
for arg in "$@"; do
  shift
  case "$arg" in
      "--reverse") set -- "$@" "-r" ;;
      "--forward") set -- "$@" "-f" ;;
      "--bam") set -- "$@" "-b" ;;
      "--controlreverse") set -- "$@" "-R" ;;
      "--controlforward") set -- "$@" "-F" ;;
      "--controlbam") set -- "$@" "-B" ;;
      "--broad") set -- "$@" "-l" ;;
      "--output") set -- "$@" "-o" ;;
      "--conf")   set -- "$@" "-c" ;;
      "--sample")   set -- "$@" "-s" ;;
      "--dryrun")   set -- "$@" "-d" ;;
      "--help")   set -- "$@" "-h" ;;
      "--version")   set -- "$@" "-v" ;;
      *)        set -- "$@" "$arg"
  esac
done

while getopts "f:r:b:F:R:B:o:c:s:dvhl" OPT
do
    case $OPT in
        f) FORWARD=$OPTARG;;
	r) REVERSE=$OPTARG;;
        b) BAM=$OPTARG;;
        F) CONTROL_FORWARD=$OPTARG;;
        R) CONTROL_REVERSE=$OPTARG;;
	B) CONTROL_BAM=$OPTARG;;
	l) set_broad_mode ;;
	o) ODIR=$OPTARG;;
	c) CONF=$OPTARG;;
	s) SAMPLE_ID=$OPTARG;;
	d) set_dry_run ;;
	v) version ;;
	h) help ;;
	\?)
		echo "Invalid option: -$OPTARG" >&2
		usage
		 exit 1
		 ;;
	:)
		echo "Option -$OPTARG requires an argument." >&2
		usage
		exit 1
		;;
	esac
done

if [[ (-z $FORWARD && -z $BAM) || -z $ODIR || -z $CONF ]]; then
    usage
    exit
fi

## Set PATHS
BIN_PATH=`dirname "$0"`
ABS_BIN_PATH=`cd "$BIN_PATH"; pwd`
SCRIPTS_PATH="$ABS_BIN_PATH/../scripts/"

## Load functions file
. $SCRIPTS_PATH/utils.inc.sh
. $SCRIPTS_PATH/chip.inc.sh

#####################
## Check Config file
#####################

if [ ! -z "$CONF" ]; then
    CONF=`abspath $CONF`
    if [ -e "$CONF" ]; then
        read_config $CONF
    else
        echo "Error - config file '$CONF' not found"
        exit
    fi
fi

###################
## WORKFLOW
###################

mkdir -p ${ODIR}/logs

## 1- MAPPING + RM_DUP
if [ -z $BAM ]; then
    bowtie2_func "${FORWARD} ${REVERSE}" ${ODIR}
    BAM=${ODIR}/mapping/$(basename $FORWARD | sed -e 's/.fastq\(.gz\)*/.bam/')
    rmDup_func $BAM ${ODIR}
    BAMnoDUP=${ODIR}/mapping/$(basename $BAM | sed -e 's/.bam/_noDup.bam/')
else
    BAMnoDUP=${BAM}
fi

if [[ -z $CONTROL_BAM && ! -z $CONTROL_FORWARD ]]; then
    bowtie2_func "${CONTROL_FORWARD} ${CONTROL_REVERSE}" ${ODIR}
    CONTROL_BAM=${ODIR}/mapping/$(basename $CONTROL_FORWARD | sed -e 's/.fastq\(.gz\)*/.bam/')
    rmDup_func $CONTROL_BAM ${ODIR}
    CONTROL_BAMnoDUP=${ODIR}/mapping/$(basename $CONTROL_BAM | sed -e 's/.bam/_noDup.bam/')
else
    CONTROL_BAMnoDUP=${CONTROL_BAM}
fi

## 3- Fragment size for PE data
if [[ $(isPEexperiment $BAMnoDUP) == "1" ]]; then
    if [ -z "${SAMPLE_ID}" ]; then
	fragSize_func $BAMnoDUP ${ODIR} $(basename $BAM .bam)
    else
	fragSize_func $BAMnoDUP ${ODIR} ${SAMPLE_ID}
    fi
else
    echo -e
    echo -e "Warning: SE experiment detected. Cannot infer fragment size"
    echo -e
fi


## 4- BigWig - take into account the ENCODE_BLACKLIST region file
bw_func ${BAMnoDUP} ${ODIR}
bw_func ${CONTROL_BAMnoDUP} ${ODIR}
BIGWIG=$(basename ${BAMnoDUP} "_noDup.bam").bw

## 5- Stats
mapping_stat "${FORWARD} ${REVERSE}" ${CONF} ${BAM} ${ODIR}

## 6- ChIP enrichment
chipenrich_func "${BAMnoDUP} ${CONTROL_BAMnoDUP}" ${ODIR}

## 7- Peak calling
macs_func ${BAMnoDUP} ${CONTROL_BAMnoDUP} ${ODIR} ${MODE}
epic_func ${BAMnoDUP} ${CONTROL_BAMnoDUP} ${ODIR}

if [[ ${MODE} == "BROAD" ]];
then
    PEAKS=${ODIR}/peaks/$(basename ${BAMnoDUP} | sed -e 's/.bam//')_peaks.broadPeak
else
    PEAKS=${ODIR}/peaks/$(basename ${BAMnoDUP} | sed -e 's/.bam//')_peaks.narrowPeak
fi

#### FRIP = fraction of reads in peaks
frip ${BAMnoDUP} ${PEAKS} ${ODIR}

## 8- REGI - Relative Enrichment in Genomics Intervals
heatmap_func ${ODIR}/tracks/${BIGWIG} "${GENE_BED}" ${ODIR}

#### Samples correlation - require multisamples

#### IDR - require multisamples + not broad
